<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>üöß Songbook Builder</title>
  </head>
  <style media="screen">
    /* https://developer.gnome.org/hig/reference/palette.html */

    :root{
      --dark3:  rgb(61,  56,  70 );
      --dark4:  rgb(36,  31,  49 );
      --dark5:  rgb(0,   0,   0  );
      --light1: rgb(255, 255, 255);
      --light2: rgb(246, 245, 244);
      --blue5:  rgb(26,  95,  180);
      --blue1:  rgb(153, 193, 241);

      --fg:   var(--dark5);
      --bg1:  var(--light1);
      --bg2:  var(--light2);
      --link: var(--blue5);
    }

    @media (prefers-color-scheme: dark) {
      :root{
        --fg:   var(--light1);
        --bg1:  var(--dark4);
        --bg2:  var(--dark3);
        --link: var(--blue1);
      }
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    main {
      width: 100%;
      max-width: 700px;
    }

    #pageHeader{
      padding-top: 30px;
    }

    #pageHeader > h1{
      margin-top: 0px;
    }
    

    dialog {
      position: relative;
      color: var(--fg);
      background-color: var(--bg1);
      border-color: var(--bg2);
      border-radius: 12px;
      max-width: min(600px, calc(100% - 75px));
      max-height: calc(100% - 75px);
      box-shadow: rgba(0, 0, 0, 0.6) 0px 20px 50px;
      /* display: grid; */
      /* overriding the display lets us style the open/close animation */
      /* opacity: 1; */
      /* transition: opacity 1s ease; */
    }

    /* dialog:not([open]) {
      pointer-events: none;
      opacity: 0;
    } */

    dialog::backdrop {
      backdrop-filter: blur(3.5px);
      transition: backdrop-filter .5s ease; /* not supported yet, but maybe in the future? */
    }

    .close_btn {
      position: absolute;
      right: 25px;
      top: 25px;
      height: 30px;
      width: 30px;
      color: var(--fg);
      background-color: var(--bg2);
      border: 0px solid transparent;
      border-radius: 100%;
      font-weight: bold;
    }

    .close_btn:hover{
      background-color: color-mix(in srgb, var(--bg2) 60%, var(--fg));
    }

    body {
      font-family: Cantarell, sans-serif;
      background-color: var(--bg1);
      color: var(--fg);

      transition: color 0.25s ease-out;
      transition: background-color 0.5s ease-out;
    }

    a, a:link, a:visited {
      color: var(--link);
      transition: all 150ms ease-in-out
    }
    a:hover {
      color: color-mix(in srgb, var(--link) 60%, white);
    }

    @keyframes spin {
      from {transform: rotate(0deg);}
      to {transform: rotate(360deg);}
    }
    .spinner{
      animation-name: spin;
      animation-duration: 2s;
      animation-iteration-count: infinite;
      animation-timing-function: linear;
      width: 30px;
      height: 30px;
      background-color: red;
      margin: 5px;
    }

    .scroll_box{
      display:block;
      max-height: 500px;
      overflow: scroll;
      background-color: var(--bg2);
    }

    .card {
      background-color: var(--bg2);
      padding: 10px;
      margin: 5px;
      border-radius: 12px;
      text-align: center;
    }
    .card > p {
      text-align: left;
    }
    .card > header {
      padding-bottom: 10px;
    }
    .columns {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      align-items: stretch;
    }
    .columns > * {
      flex-grow: 2;
    }
    .columns_sepparator{
      flex-grow: 0;
      align-self: center;
      padding: 0px 2px;
      text-align: center;
      font-size: x-large;
    }


  </style>
  <body>
    <header id="pageHeader">
      Tanner_Limes'
      <h1>Songbook Pre-processor</h1>
      <div style="background-color: black; color: yellow; padding: 10px; margin-top: -20px; text-align: center;">üöß This site is under construction üöß</div>
    </header>

    <noscript>
      <style type="text/css">
          main {
            opacity: 20%;
            pointer-events: none;
            cursor: default;
          }
      </style>
      <div class="card">
        <h2>This converter requires Javascript.</h2>
        <p>Please enable Javascript to continue.<br>
          (All of the logic happens in-browser, and you can view the code at <a href="https://github.com/charliemikels/figura-music-player">this github repo</a> )
        </p>
      </div>
    </noscript>

    <main>
      <!-- This element ‚Üì is hidden. Use `document.getElementById('existingSongbookUpload').click()` to click it. -->
      <input type="file" id="existingSongbookUpload" value="Load Existing Songbook" style="display: none;" >

      <div>
        <h3>Step 1:</h3>
        <div class="columns">
          <div class="card">
            <header>Create a new Song book</header>
            <button id="newSongbook">New Songbook</button>
          </div>
          <div class="columns_sepparator">or</div>
          <div class="card">
            <header>Add to existing songbook</header>
            <button onclick="document.getElementById('existingSongbookUpload').click()">Load Current Songbook</button>
          </div>
        </div>
      </div>

      <h3>Step 2:</h3>
      <div class="card">
        Load song file.
        <form id="uploadForm">
          <input type="file" name="directory" id="directoryInput" webkitdirectory multiple> <br>
          <input type="submit" value="Process Directory">
        </form>
      </div>
      <div id="output" class="scroll_box"></div>

      <h3>Step 3:</h3>
      <div class="card">
        TODO: Download packed config file

        <button type="button" name="button">Download</button>
      </div>

    </main>
    <footer>
      <p>for use with <a href="https://github.com/charliemikels/figura-music-player">Tanner Lime's Music Script</a> for <a href="https://github.com/FiguraMC/Figura">Figura</a></p>
      <dialog id="aboutDialog">
        <form method="dialog">
          <button class="close_btn">X</button>

          <h1>About this page</h1>
          <p>This page is a pre-processor for Tanner_Limes's Music Player script for Figura.</p>
          <p>Figura (as of version 0.1.2) does not let you read from arbitrary files from your avatar. They have to be one of the supported file types and uploaded with the avatar, or stored as a config file.</p>
          <p>I need to build a converter anyways to get song data into a format Figura can read. But we can leverage the <code>ConfigAPI</code> to store this data outside of the avatar upload.</p>
          <h2>How to use this page</h2>
          <p>
            <ol>
              <li>Load a directory of .ABC files.</li>
              <li>Click "configify"</li>
              <li> <i>Wait</i> </li>
              <li>When available, click "Save Zip"</li>
              <li>Extract the zip file into Figura's data directory: <code>[figura_root]/data</code> <br> Note: the config API doesn't support subdirectories. So yes, you have to dump every <code>TL_song_[songName].json</code> file right into the data folder.</li>
            </ol>
          </p>
          <p>Once all that is done, the music script should be able to find all of your converted songs.</p>
          <p>BTW: Everything on this page happens localy in your browser. Your song files are not actualy "uploaded" anywhere. <span style="font-size: 10pt; opacity: 75%;">But we do import a zipping library.</span></p>
        </form>
      </dialog>
      <button id="showAbout" onclick="aboutDialog.showModal()">About this page</button>
    </footer>
  </body>

<!-- https://developer.mozilla.org/en-US/docs/Web/API/HTMLInputElement/webkitdirectory -->
<!-- https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file -->
<!-- converting to base64: https://developer.mozilla.org/en-US/docs/Glossary/Base64#the_unicode_problem -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script type="text/javascript">
    /*   Steps for JS:
      1. [ ] get ABC files from user
      2. [ ] Process each:
        1. [ ] convert raw text to base 64
        2. [ ] Dump into json object
        3. [ ] Use original file path as key
        4. [ ] Dump JSON object to a string ‚Üê Alt: collect strings into single mega file.
        5. [ ] Dump string into a file
      4. [ ] collect and zip all files
      5. [ ] see if user wants to build a new songbook, or append to an existing song book.
        1. [ ] If append, ask for current songbook index file. Add new songs to index. 
      6. [ ] give zip back to user.

      Later:
      - [ ] Convert ABCs into instructions now, so that we skip that step in the avatar script.
      - [ ] Add new Instuments. (Default sin, percussian)
      - [ ] Add Support for midis, convert directly to instructions
        - [ ] Add new instruction field: Track Number.
          - All ABCs have one track. Track 1, unless "percussian" is at the end of the name, then set it to 10. 
          - In lua, add instrument picker. Coices are saved in a new config file: "TL_Songbook_meta_midi_instruments_save"
            - default all tracks to simple sin wave, unless it's track 10, then simple drum kit. 
            - Config file is a list of overides. If user picks an instrument other than the default for that track, that choice is saved to the config as
            - `song_path: {track_number: isntrument_Id, track_number: other_instrument_id}`
            - Some instruments are sourced from non-host scripts. If an saved instrument isn't found, warn user, and use the default instrument instead. (don't overwrite the setting though in case it's loaded later)
            - Add setting to overide the default instrument. (ie, play all songs through chloe piano.) This setting is saved like the other overides, so if the instrument is missing, fall back to the "actual" default instrument
      
      that's gonna be wild.            
    */

    // class song {
    //   constructor(data, name, nameLong) {
    //     this.name = name;
    //     this.data = data;
    //     this.nameLong = nameLong;
    //   }
    // }

    // thx chat gpt for this example function.
    // TIL about "blob" types.
    function exampleDownloadFunction() {
      var zip = new JSZip();

      // Add files to the ZIP archive
      zip.file("file1.txt", "Contents of file 1");
      zip.file("file2.txt", "Contents of file 2");
      // Add more files as needed

      // Generate the ZIP file
      zip.generateAsync({ type: "blob" }).then(function (content) {
        // Trigger the download
        var url = window.URL.createObjectURL(content);
        var downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = 'files.zip';
        downloadLink.click();
          // ‚Üë Simulates clicking the download link. We can instead let the user click it when they're ready.
        window.URL.revokeObjectURL(url);  // ‚Üê cleans up memory. do this before generating any new blobs.
      });
    }

    // Example usage:
    // createAndDownloadZip();

    /* -----------------------------------------------------*/

    // Alternate usage for downloading only one file:

    // // Function to trigger the download of converted data
    // function downloadConvertedData(convertedData, filename, mimeType) {
    //   var blob = new Blob([convertedData], { type: mimeType });
    //   var url = window.URL.createObjectURL(blob);
    //
    //   var downloadLink = document.createElement('a');
    //   downloadLink.href = url;
    //   downloadLink.download = filename;
    //
    //   // Trigger the download
    //   downloadLink.click();
    //
    //   // Clean up
    //   window.URL.revokeObjectURL(url);
    // }
    //
    // // Function to generate and save "Hello world.txt"
    // function generateAndSaveTextFile() {
    //   var textData = "Hello world";
    //
    //   // Trigger download for the text file
    //   downloadConvertedData(textData, 'Hello world.txt', 'text/plain');
    // }
    //
    // // Example usage:
    // generateAndSaveTextFile();

    /* -----------------------------------------------------*/

    let files = []

    

    document.getElementById("uploadForm").addEventListener("submit", function (event) {
      event.preventDefault();

      const input = document.getElementById("directoryInput");
      const outputDiv = document.getElementById("output");

      files = input.files;

      if (files.length === 0) {
        alert("Please select a directory.");
        return;
      }

      // Function to process each file
      function processFile(file) {
        const reader = new FileReader();

        reader.onload = function (e) {
          // Process the file content here
          const fileContent = e.target.result;

          // Display or handle the file content as needed
          const fileDiv = document.createElement("div");
          fileDiv.textContent = `File Name: ${file.name}, Size: ${file.size} bytes`;
          outputDiv.appendChild(fileDiv);
        };

        reader.readAsDataURL(file);
      }

      // Process each file in the selected directory
      for (const file of files) {
        processFile(file);
      }
    });



  </script>
</html>
