<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>üöß Songbook Builder</title>
  </head>
  <style media="screen">
    /* https://developer.gnome.org/hig/reference/palette.html */

    :root{
      --fg: black;
      --bg1: white;
      --bg2: WhiteSmoke;
    }

    dialog {
      position: relative;
      color: var(--fg);
      background-color: var(--bg1);
      border-color: var(--bg2);
      border-radius: 12px;
      max-width: min(600px, calc(100% - 75px));
      max-height: calc(100% - 75px);
      box-shadow: rgba(0, 0, 0, 0.6) 0px 20px 50px;
      /* display: grid; */
      /* overriding the display lets us style the open/close animation */
      /* opacity: 1; */
      /* transition: opacity 1s ease; */
    }

    /* dialog:not([open]) {
      pointer-events: none;
      opacity: 0;
    } */

    dialog::backdrop {
      backdrop-filter: blur(3.5px);
      transition: backdrop-filter .5s ease; /* not supported yet, but maybe in the future? */
    }

    .close_btn {
      position: absolute;
      right: 25px;
      top: 25px;
      height: 30px;
      width: 30px;
      color: var(--fg);
      background-color: var(--bg2);
      border: 0px solid transparent;
      border-radius: 100%;
      font-weight: bold;
    }

    .close_btn:hover{
      background-color: color-mix(in srgb, var(--bg2) 60%, var(--fg));
    }

    @media (prefers-color-scheme: dark) {
      :root{
        --fg: white;
        --bg1: rgb(36, 31, 49);
        --bg2: rgb(61, 56, 70);
      }
    }

    body {
      font-family: Cantarell, sans-serif;
      background-color: var(--bg1);
      color: var(--fg);
    }

    a, a:link, a:visited {
      color: rgb(53, 132, 228);
      transition: all 150ms ease-in-out
    }
    a:hover {
      color: color-mix(in srgb, rgb(53, 132, 228) 60%, white);
    }

    @keyframes spin {
      from {transform: rotate(0deg);}
      to {transform: rotate(360deg);}
    }
    .spinner{
      animation-name: spin;
      animation-duration: 2s;
      animation-iteration-count: infinite;
      animation-timing-function: linear;
      width: 30px;
      height: 30px;
      background-color: red;
      margin: 5px;
    }

    .scroll_box{
      display:block;
      max-height: 500px;
      overflow: scroll;
      background-color: var(--bg2);
    }
  </style>
  <body>
    <header>
      <div>Tanner_Limes'
        <span style="background-color: black; color: yellow; padding: 10px;">WIP!</span>
      </div>
      <h1>Songbook Pre-processor</h1>
    </header>

    <main>

      <dialog id="aboutDialog">
        <form method="dialog">
          <button class="close_btn">X</button>

          <h1>About this page</h1>
          <p>This page is a pre-processor for Tanner_Limes's Music Player script for Figura.</p>
          <p>Figura (as of version 0.1.2) does not let you read from arbitrary files from your avatar. They have to be one of the supported file types and uploaded with the avatar, or stored as a config file.</p>
          <p>I need to build a converter anyways to get song data into a format Figura can read. But we can leverage the <code>ConfigAPI</code> to store this data outside of the avatar upload.</p>
          <h2>How to use this page</h2>
          <p>
            <ol>
              <li>Load a directory of .ABC files.</li>
              <li>Click "configify"</li>
              <li> <i>Wait</i> </li>
              <li>When available, click "Save Zip"</li>
              <li>Extract the zip file into Figura's data directory: <code>[figura_root]/data</code> <br> Note: the config API doesn't support subdirectories. So yes, you have to dump every <code>TL_song_[songName].json</code> file right into the data folder.</li>
            </ol>
          </p>
          <p>Once all that is done, the music script should be able to find all of your converted songs.</p>
          <p>BTW: Everything on this page happens localy in your browser. Your song files are not actualy "uploaded" anywhere. <span style="font-size: 10pt; opacity: 75%;">But we do import a zipping library.</span></p>
        </form>
      </dialog>
      <button id="showAbout" onclick="aboutDialog.showModal()">About this page</button>

      <form id="uploadForm">
        <input type="file" name="directory" id="directoryInput" webkitdirectory multiple> <br>
        <input type="submit" value="Process Directory">
      </form>

      <div id="output" class="scroll_box"></div>


      <div class="">
        TODO: Download packed config file

        <button type="button" name="button">Download</button>
      </div>

      <footer>
        <p>for use with <a href="https://github.com/charliemikels/figura-music-player">Tanner Lime's Music Script</a> for <a href="https://github.com/FiguraMC/Figura">Figura</a></p>
      </footer>
    </main>
  </body>

<!-- https://developer.mozilla.org/en-US/docs/Web/API/HTMLInputElement/webkitdirectory -->
<!-- https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file -->
<!-- converting to base64: https://developer.mozilla.org/en-US/docs/Glossary/Base64#the_unicode_problem -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script type="text/javascript">
    /*   Steps for JS:
      1. [ ] get ABC files from user
      2. [ ] Process each:
        1. [ ] convert raw text to base 64
        2. [ ] Dump into json object
        3. [ ] Use original file path as key
        4. [ ] Dump JSON object to a string ‚Üê Alt: collect strings into single mega file.
        5. [ ] Dump string into a file
      4. [ ] collect and zip all files
      5. [ ] give zip back to user.
    */

    // class song {
    //   constructor(data, name, nameLong) {
    //     this.name = name;
    //     this.data = data;
    //     this.nameLong = nameLong;
    //   }
    // }

    // thx chat gpt for this example function.
    // TIL about "blob" types.
    function exampleDownloadFunction() {
      var zip = new JSZip();

      // Add files to the ZIP archive
      zip.file("file1.txt", "Contents of file 1");
      zip.file("file2.txt", "Contents of file 2");
      // Add more files as needed

      // Generate the ZIP file
      zip.generateAsync({ type: "blob" }).then(function (content) {
        // Trigger the download
        var url = window.URL.createObjectURL(content);
        var downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = 'files.zip';
        downloadLink.click();
          // ‚Üë Simulates clicking the download link. We can instead let the user click it when they're ready.
        window.URL.revokeObjectURL(url);  // ‚Üê cleans up memory. do this before generating any new blobs.
      });
    }

    // Example usage:
    // createAndDownloadZip();

    /* -----------------------------------------------------*/

    // Alternate usage for downloading only one file:

    // // Function to trigger the download of converted data
    // function downloadConvertedData(convertedData, filename, mimeType) {
    //   var blob = new Blob([convertedData], { type: mimeType });
    //   var url = window.URL.createObjectURL(blob);
    //
    //   var downloadLink = document.createElement('a');
    //   downloadLink.href = url;
    //   downloadLink.download = filename;
    //
    //   // Trigger the download
    //   downloadLink.click();
    //
    //   // Clean up
    //   window.URL.revokeObjectURL(url);
    // }
    //
    // // Function to generate and save "Hello world.txt"
    // function generateAndSaveTextFile() {
    //   var textData = "Hello world";
    //
    //   // Trigger download for the text file
    //   downloadConvertedData(textData, 'Hello world.txt', 'text/plain');
    // }
    //
    // // Example usage:
    // generateAndSaveTextFile();

    /* -----------------------------------------------------*/

    document.getElementById("uploadForm").addEventListener("submit", function (event) {
      event.preventDefault();

      const input = document.getElementById("directoryInput");
      const outputDiv = document.getElementById("output");

      const files = input.files;

      if (files.length === 0) {
        alert("Please select a directory.");
        return;
      }

      // Function to process each file
      function processFile(file) {
        const reader = new FileReader();

        reader.onload = function (e) {
          // Process the file content here
          const fileContent = e.target.result;

          // Display or handle the file content as needed
          const fileDiv = document.createElement("div");
          fileDiv.textContent = `File Name: ${file.name}, Size: ${file.size} bytes`;
          outputDiv.appendChild(fileDiv);
        };

        reader.readAsDataURL(file);
      }

      // Process each file in the selected directory
      for (const file of files) {
        processFile(file);
      }
    });



  </script>
</html>
