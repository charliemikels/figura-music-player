<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>ðŸš§ Songbook Builder</title>
  </head>
  <style media="screen">
    /* https://developer.gnome.org/hig/reference/palette.html */

    :root{
      --dark2: rgb(94, 92, 100);
      --dark3:  rgb(61,  56,  70 );
      --dark4:  rgb(36,  31,  49 );
      --dark5:  rgb(0,   0,   0  );
      --light1: rgb(255, 255, 255);
      --light2: rgb(246, 245, 244);
      --light3: rgb(222, 221, 218);
      --blue5:  rgb(26,  95,  180);
      --blue3:  rgb(53, 132, 228);
      --blue2:  rgb(98, 160, 234);
      --blue1:  rgb(153, 193, 241);

      --fg:   var(--dark5);
      --bg1:  var(--light1);
      --bg2:  var(--light2);
      --bg3:  var(--light3);
      --link: var(--blue5);
      --button-bg: var(--bg2);
      --button-hover: var(--bg3);
      --button-text: var(--fg);
      --button-sugested-bg: var(--blue3);
      --button-sugested-hover: var(--blue2);
      --button-sugested-text: var(--light1);
    }

    @media (prefers-color-scheme: dark) {
      :root{
        --fg:   var(--light1);
        --bg1:  var(--dark4);
        --bg2:  var(--dark3);
        --bg3:  var(--dark2);
        --link: var(--blue1);
      }
    }

    .wait, .wait * {
      cursor: wait;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0px;
      padding: 0px;
      min-height: 100vh;
      
      font-family: Cantarell, sans-serif;
      background-color: var(--bg1);
      color: var(--fg);
      transition: color 0.25s ease-out;
      transition: background-color 0.5s ease-out;
    }

    .hidden {
      display: none;
    }

    main {
      /* display: flex;
      flex-direction: column;
      justify-content: center; */
      width: 100%;
      max-width: 700px;

      flex-grow: 1;
      flex-shrink: 1;
    }

    #pageHeader{
      flex-grow: 1;
      max-height: 200px;
      padding-top: 30px;
    }

    #pageHeader > h1{
      margin-top: 0px;
    }
    
    dialog {
      position: relative;
      color: var(--fg);
      background-color: var(--bg1);
      border-color: var(--bg3);
      border-radius: 12px;
      max-width: min(600px, calc(100% - 75px));
      max-height: calc(100% - 75px);
      box-shadow: rgba(0, 0, 0, 0.6) 0px 20px 50px;
      /* display: grid; */
      /* overriding the display lets us style the open/close animation */
      /* opacity: 1; */
      /* transition: opacity 1s ease; */
    }

    /* dialog:not([open]) {
      pointer-events: none;
      opacity: 0;
    } */

    dialog::backdrop {
      backdrop-filter: blur(3.5px);
      transition: backdrop-filter .5s ease; /* not supported yet, but maybe in the future? */
    }

    code{
      padding: 2px 5px;
      border-radius: 3px;
      background-color: var(--bg3);
      color: var(--fg1)
    }

    a, a:link, a:visited {
      color: var(--link);
      transition: all 150ms ease-in-out
    }
    a:hover {
      color: color-mix(in srgb, var(--link) 60%, white);
    }

    .scroll_box{
      display:block;
      max-height: 500px;
      overflow: scroll;
    }

    .card {
      /* --card_color: var(--bg1); */
      --card_color: transparent;
      color: var(--fg);
      background-color: var(--card_color);
      padding: 10px;
      border: 3px solid var(--card_color);
      margin: 10px 0px;
      border-radius: 12px;
      text-align: center;
    }
    .card > .card {
      --card_color: var(--bg2);
    }

    details summary{
      cursor: pointer;
    }

    @keyframes card_appear {
      0% { 
        /* transform: translate(100px, 0); */
        opacity: 0%; 
      }
      100% { 
        /* transform: translate(0, 0); */
        opacity: 100%;
      }
    }
    .card:not(.hidden) {
      animation-name: card_appear;
      animation-duration: 0.25s; 
      animation-timing-function: ease-out; 
    }

    /* @keyframes card_hide {
      0% { 
        transform: translate(0, 0);
        opacity: 100%; 
        height: 100%;
      }
      100% { 
        transform: translate(-100px, 0);
        opacity: 0%;
        height: 0px;
      }
    } */
    /* .card.hidden {
      display: block;
      opacity: 0%;
      height: 0px;
      overflow:hidden;

      animation-name: card_hide;
      animation-duration: 5s; 
      animation-timing-function: ease-in; 
    } */
    
    /* this nested style stuff for button breaks WebkitGTK support (ie gnome web, maybe also safari?) but works fine in Chromium and firefox. so it stays. */
    button, .fake_button {
      display: inline-flex; /* flex to center text in label.fake_button */
      align-items: center;
      font-size: 12pt;

      user-select: none; 

      text-align: center;
      height: 40px;
      padding: 0 20px;
      /* padding-bottom: 2px; */
      border-radius: 20px;
      border: none;
      font-weight: bold;

      color: var(--button-text);
      background-color: var(--button-bg);
      transition: 0.2s ease;

      &:hover {
        background-color: var(--button-hover);
      }

      &.sugested {
        background-color: var(--button-sugested-bg);
        color: var(--button-sugested-text);

        &:hover {
          background-color: var(--button-sugested-hover);
        }
      }

      &.card {
        border-color: color-mix(in srgb, var(--card_color) 60%, white);
        transition: 0.2s ease;
        &:hover {
          background-color: color-mix(in srgb, var(--card_color) 80%, black);
          box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.6);
        }
      }

      &:disabled, &.sugested:disabled {
        color: color-mix(in srgb, var(--button-text) 25%, var(--button-bg));
        background-color: var(--button-bg);
      }

      &.close_btn {
        display: unset; /* should probably actualy style this right instead of resetting. Works for now though. */
        position: absolute;
        right: 25px;
        top: 25px;
        height: 30px;
        width: 30px;
        color: var(--fg);
        background-color: var(--bg3);
        border: 0px solid transparent;
        margin: 0px 0px;
        padding: 0px;
        border-radius: 100%;
        font-weight: bold;
        text-align: center;

        &:hover{
          background-color: color-mix(in srgb, var(--bg2) 60%, var(--fg));
        }
      }
    }

    .card>.scroll_box {
      background-color: var(--card_color);
      text-align: left;
    }

    .card > header {
      padding-bottom: 10px;
      font-weight: bold;
      font-size: x-large;
    }
    .columns {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      align-items: stretch;
    }
    .columns.nogrow {
      justify-content: center;
    }
    .columns:not(.nogrow) > * {
      flex-grow: 2;
    }

    .columns_sepparator{
      flex-grow: 0;
      align-self: center;
      padding: 0px 2px;
      text-align: center;
      font-size: x-large;
    }

    progress{
      display: block;
      flex-grow: 1;
      width: 100%;
      /* margin: 15px; */
      
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;

      background-color: var(--bg2);
      height: 15px;
      border: none;
      border-radius: 7.5px;
    }

    progress::-moz-progress-bar{
      background-color: var(--button-sugested-bg);
      border-radius: 7.5px;
    }

    progress::-webkit-progress-bar {
      background-color: var(--bg2);
      height: 15px;
      border: none;
      border-radius: 7.5px;
    }

    progress::-webkit-progress-value {
      background-color: var(--button-sugested-bg);
      border-radius: 7.5px;
    }

    @keyframes progress_bounce {
      to { margin-left: 80%; }
      from { margin-left: 0px; }
    }
    progress:not([value])::-moz-progress-bar {
      width: 20%;
      animation-name: progress_bounce;
      animation-duration: 1s;
      animation-direction:alternate;
      animation-iteration-count: infinite;
      animation-timing-function:ease-in-out
    }

    progress:not([value])::-webkit-progress-bar {
      width: 20%;
      color: red;
      animation-name: progress_bounce;
      animation-duration: 1s;
      animation-direction:alternate;
      animation-iteration-count: infinite;
      animation-timing-function:ease-in-out
    }


  </style>
  <body id="body">
    <header id="pageHeader">
      Tanner_Limes'
      <h1>Songbook Pre-processor</h1>
      <div style="background-color: black; color: yellow; padding: 10px; margin-top: -20px; text-align: center;">ðŸš§ This page is under construction ðŸš§</div>
      <dialog id="aboutDialog">
        <form method="dialog">
          <button class="close_btn">X</button>

          <p>for use with <a href="https://github.com/charliemikels/figura-music-player">Tanner Lime's Music Script</a> for <a href="https://github.com/FiguraMC/Figura">Figura</a></p>

          <h1>About This Page</h1>
          <p>This page is a pre-processor for Tanner_Limes's Music Player script for Figura.</p>
          <p>Figura does not (currently) let you read from arbitrary files from your avatar. They have to be one of the supported file types and uploaded with the avatar, or stored as a config file.</p>
          <p>I need to build a converter anyways to get song data into a format Figura can read. But we can leverage the <code>ConfigAPI</code> to store this data outside of the avatar upload.</p>
          <h2>How to Use This Page</h2>
          <ol>
            <li>On your computer, put all the songs you want into one folder.<br>You can use subfolders to help organize your library.</li>
            <li>Click <code>load song folder</code> and select the folder containing your music files.</li>
            <li>Check the list of uploaded files. Make any ajustments as needed.</li>
            <li>Click <code>configify</code></li>
            <li> <i>Wait</i> </li>
            <li>When available, click <code>Save Zip</code></li>
            <li>Extract the zip file into Figura's data directory: <code>[figura_root]/data</code> <br> Note: the config API doesn't support subdirectories. So yes, you have to dump every <code>TL_song_[songName].json</code> file right into the data folder.</li>
          </ol>
          <p>Once all that is done, the music script should be able to find all of your converted songs.</p>
          <h2>Usage Tips</h2>
          <ul>
            <li>This script respects the folder structure of the uploaded files. Use sub-folders to organize your library.</li>
          </ul>
          <p>BTW: Everything on this page happens localy in your browser. Your song files are not actualy "uploaded" anywhere. <span style="font-size: 9pt; opacity: 75%;">But we do import a zipping library.</span></p>
        </form>
      </dialog>
      <div style="text-align: right; width: 100%;">
        <button id="showAbout" onclick="aboutDialog.showModal()">About This Page</button>
      </div>
      
    </header>

    <noscript>
      <style type="text/css">
          main {
            opacity: 20%;
            pointer-events: none;
            cursor: default;
          }
      </style>
      <div class="card">
        <h2>This converter requires Javascript.</h2>
        <p>Please enable Javascript to continue.<br>
          All of the logic happens in-browser, and you can view the source code at <a href="https://github.com/charliemikels/figura-music-player">the github repo for this page</a>. 
          <!-- (Or you can open this HTML file in a text editor. All of the logic is in this one file) --> <!-- Script isn't done yet. The final version might load things from external libraries. -->
        </p>
      </div>
    </noscript>



    <main id="cards">
      <div id="openSongbookCard" class="card">
        <header>No Songs Loaded</header>

        <label id="uploadSongbookLabel" for="uploadSongbook" class="fake_button sugested">Select Song Folder</label>
        <input type="file" name="directory" id="uploadSongbook" style="display: none;" webkitdirectory> <br>
          <!-- accept=".abc, .mid, .midi" -->
          <!-- <input style="display: none;" type="file" name="directory" id="uploadSongbook" webkitdirectory multiple> <br> -->
      </div>

      <div id="progressCard" class="card hidden">
        <header id="progressCardTitle"></header>
        <progress id="progressCardProgress" value="0" max="100"></progress> <!-- janky ID. I know -->
        <footer id="progressCardLabel"></footer> <!-- TODO: add scroll_box class to see ongoing progress -->
      </div>

      <div id="songbookProcessConfirmation" class="card hidden">
        <header>Song Data Uploaded</header>
        <span>Found <span id="ConfirmationTotalNumberOfSongs">N</span> songs</span>
        <div id="output" class="card scroll_box">
          <details id="ConfermationUnrecognizedFilesDetails" >
            <summary><span id="ConfermationNumberOfUnrecognizedFiles">N</span> Unrecognized files (These will be ignored)</summary>
            <ul id="ConfermationUnrecognizedFilesList"><li>Hopefully a very small list</li></ul>
          </details>
          <details id="ConfermationMidiFilesDetails" >
            <summary><span id="ConfermationNumberOfMidiFiles">N</span> Midi Files</summary>
            <ul id="ConfermationMidiFilesList">
              <li>file/one.mid</li>
              <li>file/two.mid</li>
            </ul>
          </details>
          <details id="ConfermationAbcFilesDetails" >
            <summary> <span id="ConfermationNumberOfAbcFiles">N</span> ABC Files</summary>
            <ul id="ConfermationAbcFilesList">
              <li>file/one.abc</li>
              <li>file/two.abc</li>
            </ul>
          </details>
        </div>
        <div class="columns nogrow">
          <label id="cancelSongbookProcess" for="uploadSongbook" class="fake_button">Load Different Folder</label>
          <div class="columns_sepparator"></div>
          <!-- <button id="cancelSongbookProcess" onclick="">Load different folder</button> <div class="columns_sepparator"></div> -->
          <button id="confirmSongbookProcess" class="column sugested" type="button" name="button">Process Songbook</button>
        </div>
      </div>

      <div class="card hidden">
        <header>Songbook</header>
        <div id="output" class="card scroll_box"> <p><span style="opacity: 50;">No songs loaded</span></p></div>
        TODO: Download packed config file
        <button type="button" name="button">Download</button>
      </div>

    </main>
    <footer>
      
    </footer>
  </body>

<!-- https://developer.mozilla.org/en-US/docs/Web/API/HTMLInputElement/webkitdirectory -->
<!-- https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file -->
<!-- converting to base64: https://developer.mozilla.org/en-US/docs/Glossary/Base64#the_unicode_problem -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script type="text/javascript">
    "use strict";

    /*   Steps for JS:
      1. [X] get ABC files from user
      2. [ ] Process each:
        1. [ ] convert raw text to base 64
        2. [ ] Dump into json object
        3. [ ] Use original file path as key
        4. [ ] Dump JSON object to a string â† Alt: collect strings into single mega file.
        5. [ ] Dump string into a file
      4. [ ] collect and zip all files
      5. [ ] see if user wants to build a new songbook, or append to an existing song book.
        1. [ ] If append, ask for current songbook index file. Add new songs to index. 
      6. [ ] give zip back to user.

      Later:
      - [ ] Convert ABCs into instructions now, so that we skip that step in the avatar script.
      - [ ] Add new Instuments. (Default sin, percussian)
      - [ ] Add Support for midis, convert directly to instructions
        - [ ] Add new instruction field: Track Number.
          - All ABCs have one track. Track 1, unless "percussian" is at the end of the name, then set it to 10. 
          - In lua, add instrument picker. Coices are saved in a new config file: "TL_Songbook_meta_midi_instruments_save"
            - default all tracks to simple sin wave, unless it's track 10, then simple drum kit. 
            - Config file is a list of overides. If user picks an instrument other than the default for that track, that choice is saved to the config as
            - `song_path: {track_number: isntrument_Id, track_number: other_instrument_id}`
            - Some instruments are sourced from non-host scripts. If an saved instrument isn't found, warn user, and use the default instrument instead. (don't overwrite the setting though in case it's loaded later)
            - Add setting to overide the default instrument. (ie, play all songs through chloe piano.) This setting is saved like the other overides, so if the instrument is missing, fall back to the "actual" default instrument
      
      that's gonna be wild.            
    */

    // class song {
    //   constructor(data, name, nameLong) {
    //     this.name = name;
    //     this.data = data;
    //     this.nameLong = nameLong;
    //   }
    // }

    // thx chat gpt for this example function.
    // TIL about "blob" types.
    function exampleDownloadFunction() {
      var zip = new JSZip();

      // Add files to the ZIP archive
      zip.file("file1.txt", "Contents of file 1");
      zip.file("file2.txt", "Contents of file 2");
      // Add more files as needed

      // Generate the ZIP file
      zip.generateAsync({ type: "blob" }).then(function (content) {
        // Trigger the download
        var url = window.URL.createObjectURL(content);
        var downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = 'files.zip';
        downloadLink.click();
          // â†‘ Simulates clicking the download link. We can instead let the user click it when they're ready.
        window.URL.revokeObjectURL(url);  // â† cleans up memory. do this before generating any new blobs.
      });
    }

    // Example usage:
    // createAndDownloadZip();

    /* -----------------------------------------------------*/

    // Alternate usage for downloading only one file:

    // // Function to trigger the download of converted data
    // function downloadConvertedData(convertedData, filename, mimeType) {
    //   var blob = new Blob([convertedData], { type: mimeType });
    //   var url = window.URL.createObjectURL(blob);
    //
    //   var downloadLink = document.createElement('a');
    //   downloadLink.href = url;
    //   downloadLink.download = filename;
    //
    //   // Trigger the download
    //   downloadLink.click();
    //
    //   // Clean up
    //   window.URL.revokeObjectURL(url);
    // }
    //
    // // Function to generate and save "Hello world.txt"
    // function generateAndSaveTextFile() {
    //   var textData = "Hello world";
    //
    //   // Trigger download for the text file
    //   downloadConvertedData(textData, 'Hello world.txt', 'text/plain');
    // }
    //
    // // Example usage:
    // generateAndSaveTextFile();

    /* -----------------------------------------------------*/



    // see https://developer.mozilla.org/en-US/docs/Web/API/FileReader

    // User uploads a directory of songs:

    let file_list;
    // let file_load_index = 0;
    let abc_files;
    let midi_files;
    let invalid_files;

    // Set cards helpers //////////////////////////////////////////////////////////////////////////
    function setCard(cardId) {
      for (const child of document.getElementById("cards").children) {
        child.classList.add("hidden")
      }
      document.getElementById(cardId).classList.remove("hidden");
    }

    function updateProgressCard(max, value = 0, progressCardLabel) {
      document.getElementById("progressCardProgress").max = max;
      document.getElementById("progressCardProgress").value = value;
      if (progressCardLabel) {
        document.getElementById("progressCardLabel").innerHTML = progressCardLabel;
      }
    }

    function setProgressCard(progressTitle) {
      document.getElementById("progressCardTitle").innerHTML = progressTitle;
      
      setCard("progressCard");
    }

    function setConfermationCard() {
      document.getElementById("ConfirmationTotalNumberOfSongs").innerHTML = (midi_files.length + abc_files.length).toString();

      if (midi_files.length > 0) {
        document.getElementById("ConfermationMidiFilesDetails").classList.remove("hidden")
      }
      else {document.getElementById("ConfermationMidiFilesDetails").classList.add("hidden")}

      document.getElementById("ConfermationNumberOfMidiFiles").innerHTML = midi_files.length.toString();
      document.getElementById("ConfermationMidiFilesList").innerHTML = "";
      midi_files.forEach((file) => {
        let li = document.createElement("li");
        li.innerHTML = file.webkitRelativePath;
        document.getElementById("ConfermationMidiFilesList").appendChild(li)
      });

      if (abc_files.length > 0) {
        document.getElementById("ConfermationAbcFilesDetails").classList.remove("hidden")
      }
      else {document.getElementById("ConfermationAbcFilesDetails").classList.add("hidden")}

      document.getElementById("ConfermationNumberOfAbcFiles").innerHTML = abc_files.length.toString();
      document.getElementById("ConfermationAbcFilesList").innerHTML = "";
      abc_files.forEach((file) => {
        let li = document.createElement("li");
        li.innerHTML = file.webkitRelativePath;
        document.getElementById("ConfermationAbcFilesList").appendChild(li)
      });


      if (invalid_files.length > 0) {
        document.getElementById("ConfermationUnrecognizedFilesDetails").classList.remove("hidden")
      }
      else {document.getElementById("ConfermationUnrecognizedFilesDetails").classList.add("hidden")}
      document.getElementById("ConfermationNumberOfUnrecognizedFiles").innerHTML = invalid_files.length.toString();
      document.getElementById("ConfermationUnrecognizedFilesList").innerHTML = "";
      invalid_files.forEach((file) => {
        let li = document.createElement("li");
        li.innerHTML = file.webkitRelativePath;
        document.getElementById("ConfermationUnrecognizedFilesList").appendChild(li)
      });

      setCard("songbookProcessConfirmation");
    }


    // Button interactions ////////////////////////////////////////////////////////////////////////

    document.getElementById('uploadSongbook').addEventListener('change', function(e) {
      console.log("Loading " + e.target.files.length + " filesâ€¦")

      updateProgressCard(e.target.files.length, 0)
      // setProgressCard("Loading Song Folder");  // Chrome and firefox are too quick for this, progress bar shows up for too little time

      function scanUploadedFiles(fileslist) {
        file_list = Array.from(e.target.files);
        abc_files = [];
        midi_files = [];
        invalid_files = [];

        // check file types
        console.log(e.target.files);
        file_list.forEach(function(file) {
          if (file.type == "text/vnd.abc") {abc_files.push(file)}
          else if (file.type == "audio/midi") {midi_files.push(file)}
          else {invalid_files.push(file)}
        });

        console.log("Invalid files: " + invalid_files.length);
        console.log("ABC files: " + abc_files.length);
        console.log("Midi files: " + midi_files.length);


        // tmp file read tests:
        if (abc_files[0]) {
          console.log("first ABC:");
          console.log(abc_files[0]);

          const reader = new FileReader();

          reader.addEventListener("load", () => {
            console.log(reader.result);
          }, false)
          reader.readAsText(abc_files[0]);
        }

        // sort output
        function sortByPath(a, b) {
          if (a.webkitRelativePath < b.webkitRelativePath) { return -1 };
          if (a.webkitRelativePath > b.webkitRelativePath) { return 1 };
          return 0;
        }

        invalid_files.sort(sortByPath);
        midi_files.sort(sortByPath);
        abc_files.sort(sortByPath);
        
        // done. Go to next screen
        // document.getElementById("body").classList.remove("wait")
        document.getElementById("progressCardProgress").value = document.getElementById("progressCardProgress").max;
        setConfermationCard();
      };

      setTimeout(scanUploadedFiles, 1)
    });

    // In-line web workers: https://stackoverflow.com/a/6454685

    document.getElementById("uploadForm").addEventListener("submit", function (event) {
      event.preventDefault();

      const input = document.getElementById("directoryInput");
      const outputDiv = document.getElementById("output");

      const files = input.files;

      if (files.length === 0) {
        alert("Please select a directory.");
        return;
      }

      // Function to process each file
      function processFile(file) {
        const reader = new FileReader();

        reader.onload = function (e) {
          // Process the file content here
          const fileContent = e.target.result;

          // Display or handle the file content as needed
          const fileDiv = document.createElement("div");
          fileDiv.textContent = `File Name: ${file.name}, Size: ${file.size} bytes`;
          outputDiv.appendChild(fileDiv);
        };

        reader.readAsDataURL(file);
      }

      // Process each file in the selected directory
      for (const file of files) {
        processFile(file);
      }
    });



  </script>
</html>
