<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Songbook Builder</title>
    <link rel="icon" type="image/svg+xml"
      href="data:image/png;base64,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" 
    />
  </head>
  <style media="screen">
    /* https://developer.gnome.org/hig/reference/palette.html */

    :root{
      --dark2:  rgb(94,  92,  100);
      --dark3:  rgb(61,  56,  70 );
      --dark4:  rgb(36,  31,  49 );
      --dark5:  rgb(0,   0,   0  );
      --light1: rgb(255, 255, 255);
      --light2: rgb(246, 245, 244);
      --light3: rgb(222, 221, 218);
      --blue5:  rgb(26,  95,  180);
      --blue3:  rgb(53,  132, 228);
      --blue2:  rgb(98,  160, 234);
      --blue1:  rgb(153, 193, 241);

      --fg:   var(--dark5);
      --bg1:  var(--light1);
      --bg2:  var(--light2);
      --bg3:  var(--light3);
      --link: var(--blue5);
      --button-bg:    var(--bg2);
      --button-hover: var(--bg3);
      --button-text:  var(--fg);
      --button-sugested-bg:    var(--blue3);
      --button-sugested-hover: var(--blue2);
      --button-sugested-text:  var(--light1);

      transition: color 0.5s ease;
      transition: background-color 0.5s ease;
      transition: border-color 0.5s ease;
    }

    @media (prefers-color-scheme: dark) {
      :root{
        --fg:   var(--light1);
        --bg1:  var(--dark4);
        --bg2:  var(--dark3);
        --bg3:  var(--dark2);
        --link: var(--blue1);
      }
    }

    .wait, .wait * {
      cursor: wait;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0px;
      padding: 0px;
      height: 100vh;
      
      font-family: Cantarell, sans-serif;
      background-color: var(--bg1);
      color: var(--fg);
    }

    .hidden {
      display: none;
    }

    main {
      /* display: flex;
      flex-direction: column;
      justify-content: center; */
      width: 100%;
      max-width: 900px;

      flex-grow: 1;
      flex-shrink: 1;
    }

    #pageHeader{
      flex-grow: 1;
      max-height: 200px;
      padding-top: 30px;
    }

    #pageHeader > h1{
      margin-top: 0px;
    }
    
    dialog {
      position: relative;
      color: var(--fg);
      background-color: var(--bg1);
      border-color: var(--bg3);
      border-radius: 12px;
      max-width: min(600px, calc(100% - 75px));
      max-height: calc(100% - 75px);
      box-shadow: rgba(0, 0, 0, 0.6) 0px 20px 50px;
      /* display: grid; */
      /* overriding the display lets us style the open/close animation */
      /* opacity: 1; */
      /* transition: opacity 1s ease; */


      li {margin-top: 10px;}
      ol, ul {
        padding-left: 15px;
      }
    }

    /* dialog:not([open]) {
      pointer-events: none;
      opacity: 0;
    } */

    dialog::backdrop {
      backdrop-filter: blur(3.5px);
      transition: backdrop-filter .5s ease; 
        /* ↑ not supported yet, but maybe in the future? */
    }

    code{
      padding: 2px 5px;
      border-radius: 8px;
      background-color: var(--bg3);
      color: var(--fg1)
    }

    a, a:link, a:visited {
      color: var(--link);
      transition: all 150ms ease-in-out
    }
    a:hover {
      color: color-mix(in srgb, var(--link) 60%, white);
    }

    .scroll_box{
      display:block;
      /* max-height: 400px; */
      /* overflow: scroll; */
    }

    .card {
      /* --card_color: var(--bg1); */
      --card_color: transparent;
      color: var(--fg);
      background-color: var(--card_color);
      padding: 10px;
      border: 3px solid var(--card_color);
      margin: 10px 0px;
      border-radius: 12px;
      text-align: center;
    }
    .card > .card {
      --card_color: var(--bg2);
    }

    details summary{
      cursor: pointer;
    }

    @keyframes card_appear {
      0% { 
        /* transform: translate(100px, 0); */
        opacity: 0%; 
      }
      100% { 
        /* transform: translate(0, 0); */
        opacity: 100%;
      }
    }
    .card:not(.hidden) {
      animation-name: card_appear;
      animation-duration: 0.25s; 
      animation-timing-function: ease-out; 
    }

    /* @keyframes card_hide {
      0% { 
        transform: translate(0, 0);
        opacity: 100%; 
        height: 100%;
      }
      100% { 
        transform: translate(-100px, 0);
        opacity: 0%;
        height: 0px;
      }
    } */
    /* .card.hidden {
      display: block;
      opacity: 0%;
      height: 0px;
      overflow:hidden;

      animation-name: card_hide;
      animation-duration: 5s; 
      animation-timing-function: ease-in; 
    } */
    
    /*  this nested style stuff for button breaks WebkitGTK support 
        (ie gnome web, maybe also safari?) but works fine in Chromium and 
        firefox. so it stays. */
    button, .fake_button {
      display: inline-flex; /* flex to center text in label.fake_button */
      align-items: center;
      font-size: 12pt;

      user-select: none; 

      text-align: center;
      height: 40px;
      padding: 0 20px;
      /* padding-bottom: 2px; */
      border-radius: 20px;
      border: none;
      font-weight: bold;

      color: var(--button-text);
      background-color: var(--button-bg);
      transition: 0.2s ease;

      &:hover {
        background-color: var(--button-hover);
      }

      &.sugested {
        background-color: var(--button-sugested-bg);
        color: var(--button-sugested-text);

        &:hover {
          background-color: var(--button-sugested-hover);
        }
      }

      &.card {
        border-color: color-mix(in srgb, var(--card_color) 60%, white);
        transition: 0.2s ease;
        &:hover {
          background-color: color-mix(in srgb, var(--card_color) 80%, black);
          box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.6);
        }
      }

      &:disabled, &.sugested:disabled {
        color: color-mix(in srgb, var(--button-text) 25%, var(--button-bg));
        background-color: var(--button-bg);
      }

      &.close_btn {
        display: unset; 
          /*  should probably actualy style this right instead of resetting. 
              Works for now though. */
        /* position: absolute; */
        /* right: 25px;
        top: 25px; */
        height: 30px;
        width: 30px;
        color: var(--fg);
        background-color: var(--bg3);
        border: 0px solid transparent;
        margin: 0px 0px;
        padding: 0px;
        border-radius: 100%;
        font-weight: bold;
        text-align: center;

        &:hover{
          background-color: color-mix(in srgb, var(--bg2) 60%, var(--fg));
        }
      }
    }

    .card>.scroll_box {
      background-color: var(--card_color);
      text-align: left;
    }

    .card > header {
      padding-bottom: 10px;
      font-weight: bold;
      font-size: x-large;
    }
    .columns {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      align-items: stretch;
      flex-wrap:wrap-reverse;
    }
    .columns.nogrow {
      justify-content: center;
    }
    .columns:not(.nogrow) > * {
      flex-grow: 2;
      flex-shrink: 2;
    }
    .columns > .nogrow {
      flex-grow: 0;
    }

    #about_close_btn_form {
      align-self: flex-end;
      display: flex;
      flex-grow: 1;
      flex-shrink: 1;
      width: 40px;
      min-height: 40px;
      justify-content: flex-end;
    }

    #about_version_info{
      flex-grow: 100;
      flex-shrink: 1;
      flex-basis: 200px;
      /* min-width: 200px; */
    }

    .columns_sepparator{
      flex-grow: 0;
      align-self: center;
      padding: 0px 2px;
      text-align: center;
      font-size: x-large;
    }

    progress{
      display: block;
      flex-grow: 1;
      width: 100%;
      /* margin: 15px; */
      
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;

      background-color: var(--bg2);
      height: 15px;
      border: none;
      border-radius: 7.5px;
    }

    progress::-moz-progress-bar{
      background-color: var(--button-sugested-bg);
      border-radius: 7.5px;
    }

    progress::-webkit-progress-bar {
      background-color: var(--bg2);
      height: 15px;
      border: none;
      border-radius: 7.5px;
    }

    progress::-webkit-progress-value {
      background-color: var(--button-sugested-bg);
      border-radius: 7.5px;
    }

    @keyframes progress_bounce {
      to { margin-left: 80%; }
      from { margin-left: 0px; }
    }
    progress:not([value])::-moz-progress-bar {
      width: 20%;
      animation-name: progress_bounce;
      animation-duration: 1s;
      animation-direction:alternate;
      animation-iteration-count: infinite;
      animation-timing-function:ease-in-out
    }

    progress:not([value])::-webkit-progress-bar {
      width: 20%;
      color: red;
      animation-name: progress_bounce;
      animation-duration: 1s;
      animation-direction:alternate;
      animation-iteration-count: infinite;
      animation-timing-function:ease-in-out
    }

    li::marker {
      color: color-mix(in srgb, var(--fg) 50%, rgba(0,0,0,0));
    }

    ol > li::marker {
      font-size: xx-small;
    }

    @keyframes dance {
      from { transform: translateY(-5px) }
      /* 50% {} */
      to { transform: translateY(5px) }
    }
    .dance {
      display: inline-block;
      animation-name: dance;
      animation-duration: 1s;
      animation-direction:alternate;
      animation-iteration-count: infinite;
      animation-timing-function: cubic-bezier(0.77, 0, 0.175, 1);
        /* ↑ in-out sine */

      &.flip {animation-direction:alternate-reverse;}
    }

    .small {
      font-size: smaller;
      opacity:50%;
    }
    
  </style>
  <body id="body">
    <header id="pageHeader">
      Tanner_Limes'
      <h1>Songbook Builder</h1>
      <dialog id="aboutDialog">
        <div class="columns">
          <div id="about_version_info">For use with 
            <a href="https://github.com/charliemikels/figura-music-player">
              Tanner Limes' Music Player
            </a> for <a href="https://github.com/FiguraMC/Figura">Figura</a>.
            <br><span class="small">v3.0.0-beta.1--instructions-from-js</span>
          </div>
          <!-- <div class="columns_sepparator" ></div> -->
          <form id="about_close_btn_form" method="dialog">
            <button class="close_btn">X</button>
          </form>
        </div>

        <h1>Instructions</h1>
        <ol>
          <li>Put all of your song files into one folder. 
            You can organize them into sub-folders if you'd like.
          </li>

          <li>Click <code>Select Song Folder</code>. Your file browser 
            should open. Upload your songbook. 
            <ul><li>
              Note: All processing happens locally. 
              Nothing is actually "uploaded."
            </li></ul>
          </li>

          <li>Double check the file lists on the next page. 
            Click <code>Process Songbook</code> if it all looks good.
          </li>

          <li><em>wait</em>.</li>

          <li>Once the Songbook is ready, click <code>Save Songbook</code>. 
            This will "download" the songbook as a .zip file. 
            Inside you'll find 1 file for every song you included, 
            and one index file.
          </li>

          <li>Unzip songbook.zip, and put everything inside your 
            <code>[Figura Root]/data</code> folder. 
            <ul>
              <li>
                <details>
                  <summary>
                    If you don't know where that is,
                    you can get there through Minecraft.
                  </summary>
                  <ol>
                    <li>Open Minecraft.</li>
                    <li>Open the Figura menu.</li>
                    <li>Click the folder icon in the upper left.
                      <br>This should open your file browser. 
                    </li>
                    <li>Navigate up one folder.
                      <br>You should see your <code>avatar</code> folder here.
                    </li>
                    <li>Open or create the <code>data</code> folder.</li>
                    <li>Your destination is on the left.</li>
                  </ol>
                </details>
              </li>
              <li>
                Do not put these files into sub folders. 
                Everything should be place directly in the data folder.
              </li>
              <li>
                See the <a href="#limitations">limitations</a> 
                list below for more details
              </li>
            </ul>
          </li>

          <li>Profit!</li>
        </ol>
        <p>
          Your songs should now be discoverable by the music player script.
        </p>

        <h1>About This Page</h1>
        <p>
          This page can convert a folder of ABC song files into 
          Figura-ready json files. This lets you store thousands of song files
          without counting against your avatar's upload limit. 
        </p>
        <p>
          Previous versions of this script leveraged an addon mod for Figura
          called <a href="https://github.com/lexize/lutils">LUtils</a>. But 
          it has since been archived. This new method leverages the
          built-in Config API to get the same features (unlimited songs) 
          without any extra dependencies. 
        </p>

        <h1 id="limitations">Limitations</h1>
        <ul>
          <li>
            <p>
              File Types: Right now, only 
              <a href="https://en.wikipedia.org/wiki/ABC_notation">ABC</a> files
              are supported. Midi support is planned, but will not be soon.
            </p>
          </li>
          <li>
            <p>
              Adding New Songs: To add a new song to your songbook, 
              you'll have to reupload and rebuild the whole thing. 
            </p>
          </li>
          <li>
            <p>
              Messy Data Folder: Until Figura gives us support of subdirectories
              in the config API, your data folder will be a hot mess. 
            </p>
          </li>
          <li>
            <p>
              Manual Songbook Deletion: The above two limitations means that 
              you'll have to manually delete an existing songbook before 
              installing a new one, but the data folder is a shared space. Other
              scripts may be storing information there as well.
            </p>
            <p>
              All of the songbook files start with <code>TL_Songbook_</code>, 
              so they should be all together and easy to delete with 
              Bash/Batch scripts. something like <code>rm TL_Songbook_*</code>
              should be enough. 
            </p>
          </li>
          <li>
            <p>
              This isn't really a limitation, but fair warning: This page was 
              tested on Firefox and Chromium on Linux. If you're using a  
              different browser, your mileage may vary.
            </p>
          </li>
        </ul>

        <h1>3rd party tools</h1>
        <ul>
          <li><a href="https://stuk.github.io/jszip/" target="_blank">
              JSZip
            </a>: A library to zip files together
          </li>
        </ul>

      </dialog>

      <div style="text-align: right; width: 100%; margin-top: -20px;">
        <button id="showAbout" onclick="aboutDialog.showModal()">
          About This Page
        </button>
      </div>
      
    </header>

    <noscript>
      <style type="text/css">
          main {
            opacity: 20%;
            pointer-events: none;
            cursor: default;
          }
      </style>
      <div class="card">
        <h2>This converter requires Javascript.</h2>
        <p>Please enable Javascript to continue.<br>
          All of the logic happens in-browser. You can open this file in a text
          editor to see how it works, <br> or view the code at
          <a href="https://github.com/charliemikels/figura-music-player">
            the github repo for this page
          </a>. 
        </p>
      </div>
    </noscript>

    <main id="cards">
      <div id="openSongbookCard" class="card">
        <header>No Songs Loaded</header>

        <label id="uploadSongbookLabel" for="uploadSongbook" 
            class="fake_button sugested">
          Select Song Folder
        </label>
        <input type="file" name="directory" 
            id="uploadSongbook" style="display: none;" webkitdirectory> 
      </div>

      <div id="progressCard" class="card hidden">
        <header id="progressCardTitle"></header>
        <progress id="progressCardProgress" value="0" max="100"></progress>
        <footer id="progressCardLabel"></footer>
      </div>

      <div id="songbookProcessConfirmation" class="card hidden">
        <header>Song Data Uploaded</header>
        <span>Found 
          <span id="ConfirmationTotalNumberOfSongs">N</span> songs
        </span>
        <div id="output" class="card scroll_box">
          <details id="ConfermationUnrecognizedFilesDetails">
            <summary style="opacity:50%;">
              <span id="ConfermationNumberOfUnrecognizedFiles">N</span> 
              Unrecognized files (These will be ignored)
            </summary>
            <ol id="ConfermationUnrecognizedFilesList"></ol>
          </details>
          <details id="ConfermationMidiFilesDetails">
            <summary style="opacity:50%;" >
              <span id="ConfermationNumberOfMidiFiles">N</span> 
                Midi Files. Midi files are currently ignored,
                but will be supported Eventualy™.
            </summary>
            <ol id="ConfermationMidiFilesList"></ol>
          </details>
          <details id="ConfermationAbcFilesDetails">
            <summary><span id="ConfermationNumberOfAbcFiles">N</span>
              ABC Files
            </summary>
            <ol id="ConfermationAbcFilesList"></ol>
          </details>
        </div>
        <div class="columns nogrow">
          <label id="cancelSongbookProcess" 
              for="uploadSongbook" class="fake_button">
            Load Different Folder
          </label>
          <div class="columns_sepparator"></div>
          <button id="confirmSongbookProcess" class="column sugested"
              type="button" name="button">
            Process Songbook
          </button>
        </div>
      </div>

      <div id="downloadCard" class="card hidden">
        <header>
          <span class="dance">♪</span> 
          <span class="dance flip">♫</span> 
          Songbook Ready
          <span class="dance flip">♫</span> 
          <span class="dance">♪</span> 
        </header>
        Successfuly processed <span id="downloadCardSongCount">N</span> songs
        <div id="output" class="card scroll_box"> 

          <details id="downloadCardWarningDetails" class="" >
            <summary style="opacity:50%;">Warnings</summary>
            <ol id="downloadCardWarningList"></ol>
          </details>

          <details id="downloadCardSongDetails">
            <summary>Song list</summary>
            <ol id="downloadCardSongList"></ol>
          </details>
        </div>

        <div class="columns nogrow">
          <label id="downloadCardNewSongbook" 
              for="uploadSongbook" class="fake_button">
            Load Different Folder
          </label>
          <div class="columns_sepparator"></div>
          <button id="downloadCardDownloadBtn" class="column sugested"
              type="button" name="button">
            Save Songbook
          </button>
        </div>
      </div>

    </main>
    <footer>
      
    </footer>
  </body>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js">
  </script>
  <script type="text/javascript">
    "use strict";

    let file_list;
    let songBook = [];
    let songBookIndex = {};
    let songBookZip = new JSZip();
    let parseWarnings = [];
    let expectedSongs = Infinity;
    let songBookDownloadURL = "";

    let songBookFilePrefix = "TL_Songbook_Song__";
    let songBookIndexFileName = "TL_Songbook_Index.json"

    // Set cards helpers ///////////////////////////////////////////////////////
    function setCard(cardId) {
      document.getElementById("body").classList.remove("wait");
      for (const child of document.getElementById("cards").children) {
        child.classList.add("hidden")
      }
      document.getElementById(cardId).classList.remove("hidden");
    }

    function updateProgressCard(max, value, progressCardLabel) {
      document.getElementById("progressCardProgress").max = max;
      if (value) {
        document.getElementById("progressCardProgress")
                .value = value;
      } else {
        document.getElementById("progressCardProgress")
                .removeAttribute("value"); 
      }
      
      if (progressCardLabel) {
        document.getElementById("progressCardLabel")
                .innerHTML = progressCardLabel;
      }
    }

    function setProgressCard(progressTitle) {
      document.getElementById("progressCardTitle").innerHTML = progressTitle;      
      setCard("progressCard");
      document.getElementById("body").classList.add("wait");
    }

    function setConfermationCard() {
      const abc_files = [];
      const midi_files = [];
      const invalid_files = [];

      // check file types
      file_list.forEach(function(file) {
        if (getFileExtension(file.name) == "abc") {abc_files.push(file)}
        else if (getFileExtension(file.name) == "midi" 
              || getFileExtension(file.name) == "mid") {midi_files.push(file)}
        else {invalid_files.push(file)}
      });

      invalid_files.sort(sortByPath);
      midi_files.sort(sortByPath);
      abc_files.sort(sortByPath);

      document.getElementById("songbookProcessConfirmation")
              .getElementsByTagName("details")
              

      document.getElementById("ConfirmationTotalNumberOfSongs")
              .innerHTML = (midi_files.length + abc_files.length).toString();

      if (midi_files.length > 0) {
        document.getElementById("ConfermationMidiFilesDetails")
                .classList.remove("hidden")
        document.getElementById("ConfermationMidiFilesDetails")
                .open = false;
      }
      else {
        document.getElementById("ConfermationMidiFilesDetails")
                .classList.add("hidden")
      }

      document.getElementById("ConfermationNumberOfMidiFiles").innerHTML 
        = midi_files.length.toString();
      document.getElementById("ConfermationMidiFilesList").innerHTML = "";
      midi_files.forEach((file) => {
        let li = document.createElement("li");
        li.innerHTML = trimFirstDir(file.webkitRelativePath);
        document.getElementById("ConfermationMidiFilesList").appendChild(li)
      });

      if (abc_files.length > 0) {
        document.getElementById("ConfermationAbcFilesDetails")
                .classList.remove("hidden")
        document.getElementById("ConfermationAbcFilesDetails")
                .open = false;        
      }
      else {
        document.getElementById("ConfermationAbcFilesDetails")
                .classList.add("hidden")}

      document.getElementById("ConfermationNumberOfAbcFiles")
              .innerHTML = abc_files.length.toString();
      document.getElementById("ConfermationAbcFilesList").innerHTML = "";
      abc_files.forEach((file) => {
        let li = document.createElement("li");
        li.innerHTML = trimFirstDir(file.webkitRelativePath);
        document.getElementById("ConfermationAbcFilesList")
                .appendChild(li);
      });


      if (invalid_files.length > 0) {
        document.getElementById("ConfermationUnrecognizedFilesDetails")
                .classList.remove("hidden");
        document.getElementById("ConfermationUnrecognizedFilesDetails")
                .open = false;
      }
      else {
        document.getElementById("ConfermationUnrecognizedFilesDetails")
                .classList.add("hidden");
      }
      document.getElementById("ConfermationNumberOfUnrecognizedFiles")
              .innerHTML = invalid_files.length.toString();
      document.getElementById("ConfermationUnrecognizedFilesList")
              .innerHTML = "";
      invalid_files.forEach((file) => {
        let li = document.createElement("li");
        li.innerHTML = trimFirstDir(file.webkitRelativePath);
        document.getElementById("ConfermationUnrecognizedFilesList")
                .appendChild(li);
      });

      setCard("songbookProcessConfirmation");
    }

    function setDownloadCard() {
      document.getElementById("downloadCardSongCount")
              .innerHTML = songBook.length;

      document.getElementById("downloadCardWarningDetails").open = false;
      document.getElementById("downloadCardSongDetails").open = false;

      document.getElementById("downloadCardSongList").innerHTML = "";
      songBook.forEach((song) => {
        let li = document.createElement("li");
        li.innerHTML = song.name;
        document.getElementById("downloadCardSongList")
                .appendChild(li);
      });

      document.getElementById("downloadCardWarningList").innerHTML = "";
      if (parseWarnings.length == 0 ) {
        document.getElementById("downloadCardWarningDetails")
                .classList.add("hidden");
      } else {
        document.getElementById("downloadCardWarningDetails")
                .classList.remove("hidden");
        parseWarnings.forEach((warning) => {
          let li = document.createElement("li");
          li.innerHTML = warning;
          document.getElementById("downloadCardWarningList")
                  .appendChild(li);
        });
      }

      setCard("downloadCard");
    }

    // String and File helpers /////////////////////////////////////////////////
    function trimFirstDir(path) {
      const parts = path.split('/');
      parts.shift();
      return parts.join('/');
    }

    function getFileExtension(path) {
      return path.split('.').pop().toLowerCase();
    }

    // function isInteger(value) {
    //   // ty: https://stackoverflow.com/a/37674281
    //   return /^\d+$/.test(value);
    //   // "Every char between the start and then end should be a number"
    // }

    function sortByPath(a, b) {
      if (a.webkitRelativePath < b.webkitRelativePath) { return -1 };
      if (a.webkitRelativePath > b.webkitRelativePath) { return 1 };
      return 0;
    }

    // Config Processing ///////////////////////////////////////////////////////

    function stringToConfigString(str) {
      // Old meathod could fail if too many args were passed to fromCodePoint()
      // New meathod might work. See https://stackoverflow.com/a/30106551
      return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
          function toSolidBytes(match, p1) {
              return String.fromCharCode('0x' + p1);
      }));
    }

    function objToConfigObject(element) {
      // test this with:
      // JSON.stringify(objToConfigObject( my_thing ), null, 2) 
      const returnObj = {};

      switch (typeof element) {
        case "string": {
          returnObj.type = "STRING";
          returnObj.data = stringToConfigString(element);
          break;
        }
        case "number": {
          returnObj.type = (element % 1 === 0) ? "INT" : "DOUBLE";
          returnObj.data = element;
          break;
        }
        case "object": { // ← Arrays are just Objects with extra steps
          returnObj.type = "TABLE";
          returnObj.data = [];
          for (let key in element) {
            const row = {
              key: objToConfigObject(
                Array.isArray(element) 
                  ? (Number(key)+1) 
                  : key // (isInteger(value) ? Number(key) : key)

                // Arrays sometimes give their keys as strings, but
                // Lua wants ints for this, (and lua is 1 indexed anyways)
                // so we need to numberize it in some way anyways. 
              ),
              value: objToConfigObject(element[key])
            };
            returnObj.data.push(row);
          }
          break;
        } 
        case "boolean": {
          returnObj.type = "BOOL";
          returnObj.data = element;
        }
        case "undefined":
        case "null":
        default: {
          throw new Error('Unsupported element of type '+ (typeof element)
            + " ("+ element.toString() +")");
          break;
        }
      }

      return returnObj
    }

    function objToConfigFileStr(obj) {
      // assumes we're already organized ready for config file.
      // first keys are not proccessed, but their values are.
      const returnObj = {};
      for (let key in obj) {
        returnObj[key] = objToConfigObject(obj[key])
      }
      return JSON.stringify(returnObj);
    }

    // Song file processors: ABC ///////////////////////////////////////////////

    function processAbcFile(abcFile) {
      // console.log("reading ABC `"+ abcFile.webkitRelativePath +"`…");
      const reader = new FileReader();

      reader.addEventListener("load", () => {
        // console.log(reader.result);
        
        const song = {
          name: trimFirstDir(abcFile.webkitRelativePath),
          safe_path: 
            songBookFilePrefix 
              + trimFirstDir(abcFile.webkitRelativePath).replace(/\//g, "_") ,
          data: reader.result
        }

        addSongToSongBook(song);

      }, false)
      
      reader.readAsText(abcFile);
    }

    // Songbook management /////////////////////////////////////////////////////
    function newSongbook() {
      songBook = [];
      songBookIndex = {};
      parseWarnings = [];
      expectedSongs = Infinity;
      songBookZip = new JSZip();
      window.URL.revokeObjectURL(songBookDownloadURL);
      songBookDownloadURL = "";
    }

    function songBookDoneCallback() {
      console.log("All songs done!");
      console.log("processed " + songBook.length + " songs." );
      console.log(songBook);
      
      songBook.sort((a, b) => {
        if (a.safe_path < b.safe_path) { return -1 };
        if (a.safe_path > b.safe_path) { return 1 };
        return 0;
      });

      songBookIndex.index = [];
      songBook.forEach((song) => {
        songBookIndex.index.push({
          name: song.name,
          safe_path: song.safe_path
        })
      });

      songBookZip.file(
        songBookIndexFileName
        , objToConfigFileStr(songBookIndex)
      );

      // build final zip:
      setProgressCard("Zipping Songbook")
      updateProgressCard(100, null); 
      songBookZip.generateAsync(
        { type: "blob" }, 
        function updateCallback(metadata) {
          updateProgressCard(100, metadata.percent, ""); 
        }

      ).then(function (content) {
        songBookDownloadURL = window.URL.createObjectURL(content);
        
        setDownloadCard();
      });
    }

    function addConfigStrToSong(song) {
      // For easy transport, we'll keep the config file string with the song,
      // in the songbook, until we're ready to dump the strings into the zip.
      const fileObj = {}
      fileObj[song.safe_path] = song;
      song.fileStr = objToConfigFileStr(fileObj);
    }

    function addSongToSongBook(song) {
      // handles everything that happens after we're done processing a song. 
      // dumps it to the songbook object, creates the config string, 
      // tracks remaining songs, and updates the progress card. 
      // Also automaticly calls the songbook done fn when all the songbook 
      // is full. (ie, len matches expectedSongs.)
      if (song) {
        addConfigStrToSong(song);
        songBookZip.file( 
          song.safe_path+'.json'
          , song.fileStr
        );
        songBook.push(song);
      } else {
        expectedSongs--;
      }

      updateProgressCard(expectedSongs, songBook.length, "")

      if (songBook.length == expectedSongs) {
        songBookDoneCallback()
      } else if (songBook.length > expectedSongs) {
        throw new Error("songBook.length is larger than expectedsongs!")
      }
    }

    function processSongFilesIntoSongbook() {
      const start_time = Date.now();
      const numFiles = file_list.length;
      expectedSongs = file_list.length;
      let currentFileIndex = 0;

      updateProgressCard(100, 0, "");
      setProgressCard("Processing Songbook");

      function processNextSong() {
        if (currentFileIndex < numFiles) {
          const currentFile = file_list[currentFileIndex];

          // find and run processor function

          // TODO: Test this FN with web workers. Average song is ≈9kB.
          // In-line web workers: https://stackoverflow.com/a/6454685
          // probably not nesesary. since copying the file to the webworker
          // will probably be more costly than doing everything in a 
          // single threaded. But also, we need to test it. 
          switch (getFileExtension(currentFile.name)) {
            case "abc": {
              processAbcFile(currentFile);
              break;
            }
            case "mid": {}
            case "midi": {}
            default: {
              addSongToSongBook(null);
              parseWarnings.push("Ignoring unsupported file: " 
                + trimFirstDir(currentFile.webkitRelativePath));
              break;
            }
          }
          
          currentFileIndex++;

          processNextSong();
        } 
      }

      setTimeout(processNextSong, 0);
    }

    // Button interactions /////////////////////////////////////////////////////
    document.getElementById('uploadSongbook')
            .addEventListener('change', function(e) {
              
      newSongbook()
      console.log("Loading " + e.target.files.length + " files…")

      updateProgressCard(e.target.files.length, 0)
      // setProgressCard("Loading Song Folder");  
      // ↑ Chrome and firefox are too quick for this, 
      //   progress bar shows up for too little time

      function scanUploadedFiles() {
        file_list = Array.from(e.target.files);
        
        document.getElementById("progressCardProgress").value
            = document.getElementById("progressCardProgress").max;

        file_list.sort(sortByPath);
        setConfermationCard();
      };

      setTimeout(scanUploadedFiles, 1)
    });

    document.getElementById('confirmSongbookProcess')
            .addEventListener('click', function(e) {
      console.log("Process songbook!")
      processSongFilesIntoSongbook()
    });

    document.getElementById('downloadCardDownloadBtn')
            .addEventListener('click', function(e) {
      console.log("Downloading Songbook");

      let downloadLink = document.createElement('a');
      downloadLink.href = songBookDownloadURL;
      downloadLink.download = 'songbook.zip';
      downloadLink.click();
      downloadLink.remove();
    });
  </script>
</html>
